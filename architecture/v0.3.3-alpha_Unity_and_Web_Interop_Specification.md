# v0.3.3-alpha Unity and Web Interop Specification

**Version:** v0.3.3-alpha
**Status:** Partial (Web âœ…, Unity ðŸš§)
**Last Updated:** 2025-11-16

## Purpose

This document ensures the physics engine remains consistent between the Unity game and the web-based Planetary Control Panel (GEO-v1). It specifies the shared serialization format for world state, the C# P/Invoke API for Unity to read negentropic-core outputs, and the protocol for sharing simulation seeds and event logs between the two platforms.

---

## 1. Overview

### 1.1 Dual-Platform Architecture

**Two Runtime Environments:**

1. **Unity Game Client:**
   - Platform: Windows/macOS/Linux (native executable)
   - Language: C# (.NET 6.0+)
   - Physics: negentropic-core via P/Invoke
   - Rendering: Unity URP (Universal Render Pipeline)
   - Use Case: Gameplay, interactive storytelling

2. **GEO-v1 Web Interface:**
   - Platform: Browser (Chrome/Firefox/Edge)
   - Language: TypeScript + WASM
   - Physics: negentropic-core.wasm (Emscripten)
   - Rendering: CesiumJS + deck.gl
   - Use Case: Scientific visualization, education

### 1.2 Consistency Requirements

**Determinism Guarantee:**
- Same seed + same inputs â†’ identical state
- Cross-platform (Unity C#, Web WASM, Python Oracle)

**Synchronization:**
- Unity can load web-generated saves
- Web can replay Unity event logs

---

## 2. Shared State Serialization

### 2.1 Binary Format (Portable)

**Header (64 bytes):**

```c
typedef struct {
    char magic[8];               // "NEGSTATE" (8 bytes)
    uint32_t version;            // Schema version (4 bytes)
    uint32_t platform;           // 0=Unity, 1=Web, 2=Python (4 bytes)
    uint64_t timestamp_us;       // Unix epoch microseconds (8 bytes)
    uint64_t rng_seed;           // Simulation seed (8 bytes)
    uint64_t state_hash;         // XXH3 hash (8 bytes)
    uint32_t grid_rows;          // Grid dimensions (4 bytes)
    uint32_t grid_cols;          // (4 bytes)
    uint32_t num_fields;         // Number of scalar fields (4 bytes)
    uint32_t num_entities;       // SE(3) entities (4 bytes)
    uint32_t reserved[2];        // Future use (8 bytes)
} StateFileHeader;
```

**Data Payload:**

```
[Header: 64 bytes]
[Scalar Fields: num_fields Ã— grid_rows Ã— grid_cols Ã— 4 bytes (float32)]
[SE(3) Poses: num_entities Ã— 64 bytes (se3_pose_t)]
[Event Log Offset: 8 bytes (pointer to event log)]
[Event Log: variable length, NDJSON]
```

**Endianness:** Little-endian (all platforms)

**Alignment:** 16-byte (SIMD-friendly)

### 2.2 JSON Format (Human-Readable)

**Use Case:** Debugging, manual inspection, diffs

**Structure:**

```json
{
  "metadata": {
    "version": 1,
    "platform": "unity",
    "timestamp_us": 1700000000000000,
    "rng_seed": 123456789,
    "state_hash": "a1b2c3d4e5f6...",
    "grid_rows": 100,
    "grid_cols": 100
  },
  "fields": {
    "theta": [[0.12, 0.13, ...], ...],
    "som": [[0.008, 0.009, ...], ...],
    "vegetation": [[0.15, 0.16, ...], ...]
  },
  "entities": [
    {
      "entity_id": 0,
      "position": [1000.0, 2000.0, 800.0],
      "quaternion": [1.0, 0.0, 0.0, 0.0],
      "scale": [1.0, 1.0, 1.0]
    }
  ]
}
```

**Compression:** Gzip (optional, 5-10Ã— reduction)

---

## 3. Unity C# Integration

### 3.1 P/Invoke API

**C Core API (src/api/negentropic.h):**

```c
// Lifecycle
NEG_API void* neg_create(const char* config_json);
NEG_API void  neg_destroy(void* sim);

// Simulation
NEG_API int   neg_step(void* sim, float dt);
NEG_API int   neg_step_n(void* sim, float dt, int num_steps);

// State Access
NEG_API int   neg_get_field_float32(void* sim, const char* field_name, float* out_buffer, size_t buffer_size);
NEG_API int   neg_get_state_binary(void* sim, uint8_t* buffer, size_t max_len);
NEG_API int   neg_set_state_binary(void* sim, const uint8_t* buffer, size_t len);

// Validation
NEG_API uint64_t neg_get_state_hash(void* sim);
NEG_API void     neg_get_error_flags(void* sim, NegErrorFlags* out_flags);

// Event Logging
NEG_API int   neg_log_event(void* sim, const char* event_json);
NEG_API int   neg_export_event_log(void* sim, const char* file_path);
```

**C# Wrapper (NegenotropicCore.cs):**

```csharp
using System;
using System.Runtime.InteropServices;

namespace Negentropic
{
    public class Core : IDisposable
    {
        private IntPtr _simHandle;

        [DllImport("negentropic_core", CallingConvention = CallingConvention.Cdecl)]
        private static extern IntPtr neg_create(string config_json);

        [DllImport("negentropic_core", CallingConvention = CallingConvention.Cdecl)]
        private static extern void neg_destroy(IntPtr sim);

        [DllImport("negentropic_core", CallingConvention = CallingConvention.Cdecl)]
        private static extern int neg_step(IntPtr sim, float dt);

        [DllImport("negentropic_core", CallingConvention = CallingConvention.Cdecl)]
        private static extern int neg_get_field_float32(IntPtr sim, string field_name, float[] buffer, ulong buffer_size);

        [DllImport("negentropic_core", CallingConvention = CallingConvention.Cdecl)]
        private static extern ulong neg_get_state_hash(IntPtr sim);

        public Core(string configJson)
        {
            _simHandle = neg_create(configJson);
            if (_simHandle == IntPtr.Zero)
            {
                throw new Exception("Failed to create simulation");
            }
        }

        public void Step(float dt)
        {
            int result = neg_step(_simHandle, dt);
            if (result != 0)
            {
                throw new Exception($"Simulation step failed: {result}");
            }
        }

        public float[] GetField(string fieldName, int rows, int cols)
        {
            float[] buffer = new float[rows * cols];
            int result = neg_get_field_float32(_simHandle, fieldName, buffer, (ulong)buffer.Length);
            if (result != 0)
            {
                throw new Exception($"Failed to get field {fieldName}");
            }
            return buffer;
        }

        public ulong GetStateHash()
        {
            return neg_get_state_hash(_simHandle);
        }

        public void Dispose()
        {
            if (_simHandle != IntPtr.Zero)
            {
                neg_destroy(_simHandle);
                _simHandle = IntPtr.Zero;
            }
        }
    }
}
```

### 3.2 Unity Integration Example

**SimulationManager.cs:**

```csharp
using UnityEngine;
using Negentropic;

public class SimulationManager : MonoBehaviour
{
    private Core _core;
    private Texture2D _moistureTexture;

    void Start()
    {
        string config = @"{
            ""grid_rows"": 100,
            ""grid_cols"": 100,
            ""scenario"": ""LoessPlateau"",
            ""rng_seed"": 123456789
        }";

        _core = new Core(config);
        _moistureTexture = new Texture2D(100, 100, TextureFormat.RFloat, false);
    }

    void FixedUpdate()
    {
        // Step simulation (1 hour timestep)
        _core.Step(3600.0f);

        // Fetch moisture field
        float[] theta = _core.GetField("theta", 100, 100);

        // Update texture
        Color[] colors = new Color[theta.Length];
        for (int i = 0; i < theta.Length; i++)
        {
            float value = theta[i] / 0.43f;  // Normalize to [0, 1]
            colors[i] = new Color(value, value, value);
        }
        _moistureTexture.SetPixels(colors);
        _moistureTexture.Apply();
    }

    void OnDestroy()
    {
        _core?.Dispose();
    }
}
```

### 3.3 Building Native DLL

**CMake Configuration:**

```cmake
# CMakeLists.txt
cmake_minimum_required(VERSION 3.15)
project(negentropic_core C)

add_library(negentropic_core SHARED
    src/core/state.c
    src/core/rng.c
    src/solvers/hydrology_richards_lite.c
    src/solvers/regeneration_cascade.c
    src/api/negentropic.c
)

# Windows
if(WIN32)
    set_target_properties(negentropic_core PROPERTIES SUFFIX ".dll")
endif()

# macOS
if(APPLE)
    set_target_properties(negentropic_core PROPERTIES SUFFIX ".dylib")
endif()

# Linux
if(UNIX AND NOT APPLE)
    set_target_properties(negentropic_core PROPERTIES SUFFIX ".so")
endif()
```

**Build Commands:**

```bash
# Windows (x64)
mkdir build && cd build
cmake .. -G "Visual Studio 17 2022" -A x64
cmake --build . --config Release

# macOS (Universal)
cmake .. -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64"
cmake --build . --config Release

# Linux
cmake .. -DCMAKE_BUILD_TYPE=Release
make -j4
```

**Unity Plugin Folder:**

```
Assets/
â””â”€â”€ Plugins/
    â”œâ”€â”€ x86_64/
    â”‚   â””â”€â”€ negentropic_core.dll       (Windows)
    â”œâ”€â”€ x86_64/
    â”‚   â””â”€â”€ negentropic_core.so        (Linux)
    â””â”€â”€ macOS/
        â””â”€â”€ negentropic_core.bundle    (macOS Universal)
```

---

## 4. Web WASM Integration

### 4.1 Emscripten Build

**Build Script (web/build-wasm.sh):**

```bash
#!/bin/bash

emcc \
    src/core/*.c \
    src/solvers/*.c \
    src/api/negentropic.c \
    -O3 \
    -s WASM=1 \
    -s EXPORTED_FUNCTIONS='["_neg_create","_neg_destroy","_neg_step","_neg_get_field_float32","_neg_get_state_hash"]' \
    -s EXPORTED_RUNTIME_METHODS='["ccall","cwrap"]' \
    -s ALLOW_MEMORY_GROWTH=1 \
    -s MAXIMUM_MEMORY=2GB \
    -s MODULARIZE=1 \
    -s EXPORT_NAME='createNegentropicModule' \
    -o web/negentropic_core.js
```

### 4.2 TypeScript Wrapper

**negentropic-core.ts:**

```typescript
interface NegentropicModule extends EmscriptenModule {
  _neg_create: (configPtr: number) => number;
  _neg_destroy: (simPtr: number) => void;
  _neg_step: (simPtr: number, dt: number) => number;
  _neg_get_field_float32: (simPtr: number, fieldPtr: number, bufferPtr: number, bufferSize: number) => number;
  _neg_get_state_hash: (simPtr: number) => bigint;
}

export class NegenotropicCore {
  private module: NegentropicModule;
  private simPtr: number = 0;

  constructor(module: NegentropicModule) {
    this.module = module;
  }

  create(config: object): void {
    const configJson = JSON.stringify(config);
    const configPtr = this.module.allocateUTF8(configJson);
    this.simPtr = this.module._neg_create(configPtr);
    this.module._free(configPtr);

    if (this.simPtr === 0) {
      throw new Error('Failed to create simulation');
    }
  }

  step(dt: number): void {
    const result = this.module._neg_step(this.simPtr, dt);
    if (result !== 0) {
      throw new Error(`Simulation step failed: ${result}`);
    }
  }

  getField(fieldName: string, rows: number, cols: number): Float32Array {
    const fieldPtr = this.module.allocateUTF8(fieldName);
    const bufferSize = rows * cols;
    const bufferPtr = this.module._malloc(bufferSize * 4);

    const result = this.module._neg_get_field_float32(
      this.simPtr,
      fieldPtr,
      bufferPtr,
      bufferSize
    );

    if (result !== 0) {
      throw new Error(`Failed to get field ${fieldName}`);
    }

    const buffer = new Float32Array(
      this.module.HEAPF32.buffer,
      bufferPtr,
      bufferSize
    );
    const copy = new Float32Array(buffer);  // Copy before free

    this.module._free(fieldPtr);
    this.module._free(bufferPtr);

    return copy;
  }

  getStateHash(): bigint {
    return this.module._neg_get_state_hash(this.simPtr);
  }

  destroy(): void {
    if (this.simPtr !== 0) {
      this.module._neg_destroy(this.simPtr);
      this.simPtr = 0;
    }
  }
}
```

### 4.3 Web Worker Integration

**core-worker.ts:**

```typescript
import { NegenotropicCore } from './negentropic-core';

let core: NegenotropicCore | null = null;

self.onmessage = async (e: MessageEvent) => {
  const { type, payload } = e.data;

  switch (type) {
    case 'init':
      const module = await createNegentropicModule();
      core = new NegenotropicCore(module);
      core.create(payload.config);
      self.postMessage({ type: 'init_complete' });
      break;

    case 'step':
      if (!core) throw new Error('Core not initialized');
      core.step(payload.dt);

      const theta = core.getField('theta', 100, 100);
      const hash = core.getStateHash();

      self.postMessage({
        type: 'step_complete',
        payload: { theta, hash }
      });
      break;

    case 'destroy':
      core?.destroy();
      core = null;
      break;
  }
};
```

---

## 5. Seed and Event Log Sharing

### 5.1 Seed Synchronization

**Unity â†’ Web:**

```csharp
// Unity: Export simulation with seed
string stateJson = JsonUtility.ToJson(new {
    rng_seed = 123456789,
    grid_rows = 100,
    grid_cols = 100,
    scenario = "LoessPlateau"
});

File.WriteAllText("export/simulation.json", stateJson);
```

**Web: Import seed**

```typescript
const stateJson = await fetch('import/simulation.json').then(r => r.json());
core.create(stateJson);
```

**Result:** Identical initial state across platforms

### 5.2 Event Log Protocol

**Unity: Log events**

```csharp
public void PlaceIntervention(int x, int y, string type)
{
    string eventJson = JsonUtility.ToJson(new {
        event_type = "place_intervention",
        timestamp_us = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds() * 1000,
        payload = new {
            intervention_type = type,
            position = new[] { x, y }
        }
    });

    _core.LogEvent(eventJson);
}
```

**Web: Replay Unity log**

```typescript
const eventLog = await fetch('import/event_log.ndjson').then(r => r.text());
const events = eventLog.split('\n').map(line => JSON.parse(line));

for (const event of events) {
  if (event.event_type === 'simulation_step') {
    core.step(event.payload.dt_seconds);
  } else if (event.event_type === 'place_intervention') {
    applyIntervention(event.payload);
  }
}
```

### 5.3 Cross-Platform Validation

**Hash Checkpoints:**

```csharp
// Unity (after 1000 steps)
ulong unityHash = _core.GetStateHash();
File.WriteAllText("checkpoints/step_1000_unity.txt", unityHash.ToString("X16"));
```

```typescript
// Web (after 1000 steps)
const webHash = core.getStateHash();
console.log(`Web hash: ${webHash.toString(16)}`);

// Compare
const unityHashFile = await fetch('checkpoints/step_1000_unity.txt').then(r => r.text());
const unityHash = BigInt(`0x${unityHashFile.trim()}`);

if (webHash === unityHash) {
  console.log('âœ… Cross-platform validation passed');
} else {
  console.error('âŒ Hash mismatch:', { unity: unityHash, web: webHash });
}
```

---

## 6. Performance Considerations

### 6.1 Unity C# Interop Overhead

**Benchmarks (100Ã—100 grid):**

| Operation | Managed C# | P/Invoke C | Overhead |
|-----------|------------|------------|----------|
| Step simulation | N/A | 2.5 ms | - |
| GetField (copy) | 0.3 ms | 0.1 ms | +0.2 ms |
| Total (per frame) | - | 2.6 ms | ~10% |

**Mitigation:**
- Batch multiple steps before fetch: `neg_step_n(sim, dt, 10)`
- Use SharedArrayBuffer-like approach (unsafe C# pointers)

### 6.2 WASM Performance

**Benchmarks:**

| Metric | Native C | WASM | Ratio |
|--------|----------|------|-------|
| HYD step | 15 ns/cell | 22 ns/cell | 1.5Ã— slower |
| REG step | 25 ns/cell | 35 ns/cell | 1.4Ã— slower |
| Memory bandwidth | 20 GB/s | 8 GB/s | 2.5Ã— slower |

**Optimizations:**
- SIMD (WASM SIMD extension): +30% speedup
- Threading (SharedArrayBuffer): +2Ã— speedup

---

## 7. Testing Strategy

### 7.1 Unit Tests (Per Platform)

**Unity (NUnit):**

```csharp
[Test]
public void TestStepDeterminism()
{
    var core1 = new Core("{\"rng_seed\": 123}");
    var core2 = new Core("{\"rng_seed\": 123}");

    core1.Step(3600.0f);
    core2.Step(3600.0f);

    Assert.AreEqual(core1.GetStateHash(), core2.GetStateHash());
}
```

**Web (Jest):**

```typescript
test('Step determinism', async () => {
  const module1 = await createNegentropicModule();
  const module2 = await createNegentropicModule();

  const core1 = new NegenotropicCore(module1);
  const core2 = new NegenotropicCore(module2);

  core1.create({ rng_seed: 123 });
  core2.create({ rng_seed: 123 });

  core1.step(3600);
  core2.step(3600);

  expect(core1.getStateHash()).toBe(core2.getStateHash());
});
```

### 7.2 Cross-Platform Integration Tests

**Automated Workflow:**

```yaml
# .github/workflows/cross_platform_test.yml
name: Cross-Platform Test

on: [push]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]

    steps:
      - name: Build native DLL
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build

      - name: Run Unity tests (Mono)
        run: |
          mono NUnit.ConsoleRunner.exe Tests/NegenotropicTests.dll

      - name: Build WASM
        run: |
          ./web/build-wasm.sh

      - name: Run Web tests (Node.js)
        run: |
          npm test

      - name: Cross-validation
        run: |
          python tests/cross_platform_validation.py
```

---

## 8. Future Extensions

### 8.1 Unity Jobs System Integration

**Burst-Compiled Physics:**

```csharp
using Unity.Burst;
using Unity.Jobs;

[BurstCompile]
struct HydrologyJob : IJobParallelFor
{
    public NativeArray<float> theta;
    public float dt;

    public void Execute(int index)
    {
        // Burst-compiled hydrology step (direct C translation)
        theta[index] = richardsLiteStepBurst(theta[index], dt);
    }
}

// Dispatch
var job = new HydrologyJob { theta = thetaArray, dt = 3600f };
job.Schedule(10000, 64).Complete();
```

**Performance:** ~5Ã— faster than P/Invoke for tight loops

### 8.2 WebGPU Compute Shaders

**GPU-Accelerated Hydrology:**

```wgsl
@group(0) @binding(0) var<storage, read> theta_in: array<f32>;
@group(0) @binding(1) var<storage, read_write> theta_out: array<f32>;

@compute @workgroup_size(16, 16)
fn richards_lite(@builtin(global_invocation_id) id: vec3<u32>) {
    let idx = id.y * grid_width + id.x;
    theta_out[idx] = richards_step(theta_in[idx], dt);
}
```

**Expected Speedup:** 10-100Ã— for large grids (>512Ã—512)

---

## 9. References

1. **P/Invoke:** Microsoft, ".NET Native Interoperability" (2023)
2. **Emscripten:** Zakai, A. "Emscripten: An LLVM-to-JavaScript Compiler" (2011)
3. **Unity Burst:** Unity Technologies, "Burst Compiler Documentation" (2023)
4. **WebAssembly SIMD:** W3C WebAssembly Working Group, "Fixed-Width SIMD" (2021)
5. **WebGPU:** W3C GPU for the Web Working Group, "WebGPU Specification" (2023)

---

**Document Control:**
- **Approved by:** Technical Lead
- **Status:** Partial (Web âœ…, Unity ðŸš§)
- **Review Frequency:** Every release
- **Next Review:** v0.4.0-alpha
