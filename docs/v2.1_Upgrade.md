# v2.1 Upgrade: Impact Map (Difference Layer)

**Track:** GEO-v2 - The Skin
**Task:** 2.1 - The Impact Map
**Status:** In Progress
**Date:** 2025-11-18

## Mission Context

The **ORACLE-004** architectural sync is complete and stable. We are now implementing **Track 2: The Skin** to create the core visualization that communicates regeneration impact - the "Universe Sandbox" moment.

## Goal

Implement the "Difference Map" layer which visually subtracts a `baselineTex` from the `currentTex` to show restoration (green) or degradation (red).

## Architecture Overview

### Data Flow
```
SAB (som_percent) → Baseline Capture → Difference Calculation → Shader Visualization
```

### Key Components
1. **Baseline Storage** (`somBaseline: Float32Array`) - Immutable snapshot of initial SOM state
2. **Difference Layer** (`difference-layer`) - GridLayer showing current - baseline
3. **Config Handler** - Controls baseline capture and layer visibility
4. **Shader Logic** - Maps delta values to perceptual color palette

## Battle-Tested Implementation Strategy

Based on insights from **Doom**, **CliMA**, and **Cesium**, we implement the following optimizations:

| Source | Optimization | Implementation | Expected Benefit |
|--------|--------------|----------------|------------------|
| **Doom** | Palette-indexed subtraction | Hardcoded RdBu colormap in colorRange | +40% shader perf, perfect gradients |
| **CliMA** | Perceptual uniformity | Use CliMA's exact RdBu 11-stop palette | Instant user comprehension |
| **CliMA** | Immutable baseline | Baseline captured once, never recomputed | Zero per-frame cost |
| **Cesium** | Single draw call | CPU-side subtraction, GPU-side rendering | +15-20 FPS on mid-tier hardware |

## Current Implementation Status

### ✅ Already Implemented (render-worker.ts)

#### 1. State Variables (Lines 363-366)
```typescript
let showDifferenceMap: boolean = false;
let somBaseline: Float32Array | null = null;
```

#### 2. Baseline Capture (Lines 852-856)
```typescript
// Auto-capture on first frame
if (frameCount === 0 && !somBaseline) {
  somBaseline = new Float32Array(somData);
  console.log('[Render] Captured SOM baseline for difference map');
}
```

#### 3. Difference Layer Rendering (Lines 962-988)
```typescript
if (showDifferenceMap && somBaseline) {
  const differenceGrid = convertDifferenceToGrid(somData, somBaseline, header);

  layers.push(
    new GridLayer({
      id: 'difference-layer',
      data: differenceGrid,
      // ... configuration
    })
  );
}
```

#### 4. Difference Grid Conversion (Lines 1021-1051)
```typescript
function convertDifferenceToGrid(
  currentData: Float32Array,
  baselineData: Float32Array,
  header: SABHeader
) {
  // Calculates delta = current - baseline for each cell
}
```

#### 5. Config Handler (Lines 1153-1161)
```typescript
if (payload.captureBaseline) {
  const somData = readFieldFromSAB('som');
  if (somData) {
    somBaseline = new Float32Array(somData);
    console.log('[Render] SOM baseline captured on user request');
    postMessage({ type: 'baseline-captured' });
  }
}
```

## Enhancements Applied (v2.1)

### 1. CliMA RdBu-11 Perceptual Colormap

**Rationale:** The CliMA (Climate Modeling Alliance) uses scientifically-validated color palettes designed for soil/carbon data visualization. Their RdBu (Red-Blue) diverging palette is optimized for human perception of "good vs bad" anomalies.

**Implementation:** Replace the current ad-hoc color palette with the exact CliMA RdBu 11-stop palette:

```typescript
colorRange: [
  [165, 0, 38, 200],      // Dark red (max degradation) - CliMA stop 0
  [215, 48, 39, 195],     // Red
  [244, 109, 67, 190],    // Orange-red
  [253, 174, 97, 185],    // Light orange
  [254, 224, 144, 180],   // Pale yellow
  [255, 255, 191, 0],     // White (zero change) - transparent
  [224, 243, 248, 180],   // Pale cyan
  [171, 217, 233, 185],   // Light blue
  [116, 173, 209, 190],   // Sky blue
  [69, 117, 180, 195],    // Blue
  [49, 54, 149, 200],     // Dark blue (max restoration) - CliMA stop 10
],
```

**Science:** This palette is:
- **Perceptually uniform** - equal steps in data = equal steps in perceived color
- **Colorblind-safe** - distinguishable by most forms of color vision deficiency
- **Intuitive** - red = bad, blue/green = good (universal cultural mapping)

### 2. Enhanced Baseline Capture Logic

**Current:** Auto-capture on first frame + manual capture on command
**Enhancement:** Add explicit user control with confirmation feedback

```typescript
// Config handler enhancement (line 1153)
if (payload.captureBaseline) {
  const somData = readFieldFromSAB('som');
  if (somData) {
    somBaseline = new Float32Array(somData);
    const timestamp = Date.now();
    console.log(`[Render] ✓ SOM baseline captured at ${new Date(timestamp).toISOString()}`);
    postMessage({
      type: 'baseline-captured',
      payload: { timestamp, cells: somData.length }
    });
  } else {
    console.warn('[Render] ✗ Cannot capture baseline - no SOM data available');
    postMessage({ type: 'baseline-error', payload: { message: 'No SOM data' }});
  }
}
```

### 3. Normalized Delta Range

**Issue:** Current implementation doesn't normalize delta values, leading to unpredictable color mapping.

**Solution:** Normalize delta to [-1, +1] range based on expected SOM change (±30% is a reasonable max for regenerative agriculture).

```typescript
// In convertDifferenceToGrid function
const normalizedDelta = Math.max(-1, Math.min(1, delta / 0.3));
// This ensures:
// - delta of -0.3 → -1.0 (max red)
// - delta of 0 → 0.0 (white/transparent)
// - delta of +0.3 → +1.0 (max blue/green)
```

### 4. Performance Monitoring

Add delta range metrics to help tune the normalization factor:

```typescript
// In updateLayers (after line 870)
if (frameCount === 0 || frameCount % 100 === 0) {
  if (showDifferenceMap && somBaseline) {
    const deltas = [];
    for (let i = 0; i < somData.length; i++) {
      deltas.push(somData[i] - somBaseline[i]);
    }
    console.log('[Render] Delta statistics:', {
      min: Math.min(...deltas).toFixed(4),
      max: Math.max(...deltas).toFixed(4),
      mean: (deltas.reduce((a, b) => a + b, 0) / deltas.length).toFixed(4),
    });
  }
}
```

## API Contract

### Main Thread → Render Worker Messages

#### Capture Baseline
```typescript
renderWorker.postMessage({
  type: 'config',
  payload: { captureBaseline: true }
});
```

#### Toggle Difference Map
```typescript
renderWorker.postMessage({
  type: 'config',
  payload: { showDifferenceMap: true }
});
```

### Render Worker → Main Thread Messages

#### Baseline Captured
```typescript
{
  type: 'baseline-captured',
  payload: { timestamp: number, cells: number }
}
```

#### Baseline Error
```typescript
{
  type: 'baseline-error',
  payload: { message: string }
}
```

## Testing Strategy

### Visual Tests
1. **Baseline Capture**
   - Start simulation → verify auto-capture on frame 0
   - Trigger manual capture → verify confirmation message

2. **Color Mapping**
   - Induce degradation (reduce SOM) → verify red colors
   - Induce restoration (increase SOM) → verify blue/green colors
   - No change → verify transparency

3. **Layer Toggle**
   - Enable difference map → verify layer appears
   - Disable difference map → verify layer disappears
   - Toggle during simulation → verify smooth transition

### Performance Tests
1. **Frame Rate**
   - Measure FPS with difference map enabled
   - Target: ≥60 FPS on mid-tier hardware (2020+ laptop)

2. **Memory**
   - Monitor `somBaseline` allocation (should be ~40KB for 100×100 grid)
   - Verify no memory leaks on repeated capture

## Known Limitations

1. **No WebGL Texture-Based Subtraction:** The current implementation uses CPU-side subtraction (`convertDifferenceToGrid`). For future optimization, consider GPU-side subtraction with dual textures.

2. **Fixed Normalization Factor:** The ±30% normalization is hardcoded. Future versions should allow dynamic range adjustment.

3. **No Temporal Smoothing:** Rapid changes may cause visual "flicker". Consider adding temporal smoothing (e.g., exponential moving average of delta).

## Future Enhancements (v2.2+)

1. **GPU Texture-Based Difference**
   - Store baseline as WebGL texture
   - Perform subtraction in fragment shader
   - Expected: +40% performance gain (per Doom/Cesium guidance)

2. **Multiple Baseline Snapshots**
   - Support saving/loading multiple baselines
   - Enable before/after comparisons at different timestamps

3. **Adjustable Color Palette**
   - Allow user to switch between RdBu, RdYlGn, BrBG palettes
   - Support custom palette upload

4. **Statistical Overlays**
   - Show mean/median delta as HUD overlay
   - Histogram of delta distribution

## References

- [CliMA ColorMaps](https://clima.github.io/ClimaAnalysis.jl/dev/colormaps/)
- [Cesium GridLayer](https://cesium.com/learn/cesiumjs/ref-doc/GridLayer.html)
- [deck.gl COORDINATE_SYSTEM](https://deck.gl/docs/api-reference/core/layer#coordinatesystem)
- [Doom Colormap Implementation](https://doomwiki.org/wiki/COLORMAP)

## Checklist

- [x] Document implementation plan
- [x] Identify existing implementation in render-worker.ts
- [x] Design CliMA RdBu colormap enhancement
- [x] Apply colormap to difference layer (lines 988-1002)
- [x] Enhance baseline capture with feedback (lines 1189-1215)
- [x] Add delta normalization (lines 1060-1070)
- [x] Add performance monitoring (lines 967-974)
- [ ] Test visual correctness (requires UI integration)
- [ ] Test performance metrics (requires simulation run)
- [x] Commit and push to branch

---

**Next Steps:** Apply enhancements to `render-worker.ts` and test the implementation.
