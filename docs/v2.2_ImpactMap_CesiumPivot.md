# v2.2 ORACLE-005: Cesium Primitive Pivot

**Track:** GEO-v2 - The Skin (Critical Architectural Pivot)
**Task:** ORACLE-005 - Replace deck.gl with Cesium Primitives
**Status:** In Progress
**Date:** 2025-11-18

## Mission Context

The **ORACLE-004** architecture (deck.gl custom MatrixView over Cesium) has proven unstable due to:
1. **Vertex buffer errors** in ScatterplotLayer at high instance counts
2. **Flickering and z-fighting** at extreme zoom levels
3. **Performance collapse** (0.4 FPS) due to GL instabilities
4. **Projection singularities** at polar regions and extreme angles

The fundamental issue is not synchronization logic - it's the architectural instability of deck.gl's custom view system operating over a full ECEF globe.

## Strategic Decision: ORACLE-005

**Abandon deck.gl for the Impact Map and implement using Cesium's native Primitives.**

### Why Cesium Primitives?

| Advantage | Benefit |
|-----------|---------|
| **Native ECEF Support** | No projection mismatch or coordinate transformation issues |
| **Instanced Geometry** | Efficient GPU rendering for 100k+ cells at 60 FPS |
| **Depth-Tested Rendering** | Perfect z-ordering with terrain and globe |
| **Stable API** | Production-tested for geospatial visualization |
| **Direct Control** | Full control over geometry, attributes, and shaders |

## Architecture Comparison

### ORACLE-004 (deck.gl - DEPRECATED)
```
Main Thread (Cesium Viewer)
    ↓ Camera matrices
Worker Thread (deck.gl)
    ↓ Custom MatrixView
    ↓ ScatterplotLayer/GridLayer
    ↓ OffscreenCanvas
    → INSTABILITY (vertex buffer errors, flickering)
```

### ORACLE-005 (Cesium Primitives - NEW)
```
Main Thread (Cesium Viewer)
    ↓ Scene primitives
    ↓ GeometryInstance collection
    ↓ PerInstanceColorAppearance
    ↓ Direct canvas rendering
    → STABILITY (60 FPS, perfect alignment)
```

## Implementation Plan

### Track A: Impact Map (Cesium Primitives)

#### 1. Remove deck.gl Dependencies

**Files to modify:**
- `web/src/workers/render-worker.ts` - Remove or deprecate deck.gl code
- `web/package.json` - Mark deck.gl dependencies as optional or remove

**Code to remove:**
- `MatrixView` class and WeakMap storage
- deck.gl module loading
- Custom view synchronization logic
- OffscreenCanvas transfer logic

**Code to keep (for SAB pipeline):**
- SAB data reading functions
- Field offset management
- Baseline capture logic
- Delta calculation functions

#### 2. Implement Cesium Primitive Core

**Location:** `web/src/main.ts` (main thread, after Cesium viewer init)

**Components:**

##### a. Difference Map State
```typescript
private differenceCollection: Cesium.PrimitiveCollection | null = null;
private differenceInstances: Cesium.GeometryInstance[] = [];
private somBaseline: Float32Array | null = null;
private showDifferenceMap: boolean = false;
```

##### b. Initialization Function
```typescript
private initDifferenceMap() {
  // Create primitive collection for difference layer
  this.differenceCollection = new Cesium.PrimitiveCollection();
  this.viewer.scene.primitives.add(this.differenceCollection);

  // Create instanced geometry for each grid cell
  // Use billboarded quads for perfect cell shapes at all angles
  const instances = this.createDifferenceGeometry();

  // Create primitive with per-instance color appearance
  const primitive = new Cesium.Primitive({
    geometryInstances: instances,
    appearance: new Cesium.PerInstanceColorAppearance({
      flat: true,
      translucent: true,
      renderState: {
        depthTest: { enabled: true },
        blending: Cesium.BlendingState.ALPHA_BLEND,
      }
    }),
    asynchronous: false
  });

  this.differenceCollection.add(primitive);
}
```

##### c. Geometry Creation
```typescript
private createDifferenceGeometry(): Cesium.GeometryInstance[] {
  const instances: Cesium.GeometryInstance[] = [];
  const gridSize = 100; // 100x100 grid
  const cellSizeMeters = 100; // 100m x 100m cells

  // Read bbox from SAB header
  const bbox = this.readBBoxFromSAB();

  const lonStep = (bbox.maxLon - bbox.minLon) / gridSize;
  const latStep = (bbox.maxLat - bbox.minLat) / gridSize;

  for (let row = 0; row < gridSize; row++) {
    for (let col = 0; col < gridSize; col++) {
      const lon = bbox.minLon + (col + 0.5) * lonStep;
      const lat = bbox.minLat + (row + 0.5) * latStep;

      // Create quad geometry at cell position
      const position = Cesium.Cartesian3.fromDegrees(lon, lat, 10); // 10m above surface

      const instance = new Cesium.GeometryInstance({
        geometry: new Cesium.RectangleGeometry({
          rectangle: Cesium.Rectangle.fromDegrees(
            lon - lonStep/2, lat - latStep/2,
            lon + lonStep/2, lat + latStep/2
          ),
          height: 10,
          vertexFormat: Cesium.VertexFormat.POSITION_ONLY
        }),
        id: `cell-${row}-${col}`,
        attributes: {
          color: Cesium.ColorGeometryInstanceAttribute.fromColor(
            Cesium.Color.WHITE.withAlpha(0)
          )
        }
      });

      instances.push(instance);
    }
  }

  return instances;
}
```

##### d. Color Update Function
```typescript
private updateDifferenceColors() {
  if (!this.somBaseline || !this.differenceInstances.length) return;

  const currentSOM = this.readSOMFromSAB();
  if (!currentSOM) return;

  this.differenceInstances.forEach((instance, i) => {
    const current = currentSOM[i];
    const baseline = this.somBaseline![i];
    const delta = current - baseline;

    // Normalize to [-1, +1] range (±30% max)
    const normalizedDelta = Math.max(-1, Math.min(1, delta / 0.3));

    // Get CliMA RdBu-11 color
    const color = this.getRdBu11Color(normalizedDelta);

    // Update instance color
    instance.attributes.color = Cesium.ColorGeometryInstanceAttribute.fromColor(color);
  });

  // Cesium auto-updates the primitive
}
```

##### e. CliMA RdBu-11 Color Mapping
```typescript
private getRdBu11Color(normalizedValue: number): Cesium.Color {
  // normalizedValue in [-1, +1] range
  // Map to [0, 1] for palette index
  const t = (normalizedValue + 1) / 2; // 0 = red, 0.5 = white, 1 = blue

  // CliMA RdBu-11 palette (11 stops)
  const palette = [
    [165, 0, 38],      // 0.0 - Dark red (max degradation)
    [215, 48, 39],     // 0.1
    [244, 109, 67],    // 0.2
    [253, 174, 97],    // 0.3
    [254, 224, 144],   // 0.4
    [255, 255, 191],   // 0.5 - White (no change)
    [224, 243, 248],   // 0.6
    [171, 217, 233],   // 0.7
    [116, 173, 209],   // 0.8
    [69, 117, 180],    // 0.9
    [49, 54, 149],     // 1.0 - Dark blue (max restoration)
  ];

  // Interpolate between palette stops
  const index = t * 10;
  const i = Math.floor(index);
  const frac = index - i;
  const i1 = Math.min(i, 9);
  const i2 = Math.min(i + 1, 10);

  const c1 = palette[i1];
  const c2 = palette[i2];

  const r = c1[0] + (c2[0] - c1[0]) * frac;
  const g = c1[1] + (c2[1] - c1[1]) * frac;
  const b = c1[2] + (c2[2] - c1[2]) * frac;

  // Transparency: hide near-zero changes
  const alpha = Math.abs(normalizedValue) < 0.05 ? 0.0 : 0.78;

  return new Cesium.Color(r / 255, g / 255, b / 255, alpha);
}
```

#### 3. SAB Data Pipeline

**Keep existing SAB reading functions, but move to main thread:**

```typescript
private readSOMFromSAB(): Float32Array | null {
  if (!this.sab) return null;

  const headerSize = 128;
  const gridSize = 100 * 100;
  const somOffset = headerSize + gridSize * 4; // Second field

  return new Float32Array(this.sab, somOffset, gridSize);
}

private readBBoxFromSAB(): BoundingBox {
  if (!this.sab) {
    return { minLon: -95.1, minLat: 39.9, maxLon: -94.9, maxLat: 40.1 };
  }

  const view = new DataView(this.sab);
  return {
    minLon: view.getFloat32(24, true),
    minLat: view.getFloat32(28, true),
    maxLon: view.getFloat32(32, true),
    maxLat: view.getFloat32(36, true),
  };
}
```

#### 4. Render Loop Integration

**Add to main render loop:**

```typescript
private startDifferenceMapLoop() {
  const update = () => {
    if (this.showDifferenceMap) {
      this.updateDifferenceColors();
    }
    requestAnimationFrame(update);
  };
  update();
}
```

### Track B: Camera & UX Enhancements

#### 1. Switch to CesiumWorldTerrain

**Location:** `main.ts` - `initializeCesium()` method

```typescript
// Add after viewer creation (line ~221)
console.log('Loading world terrain...');
this.viewer.terrainProvider = await Cesium.CesiumTerrainProvider.fromUrl(
  Cesium.IonResource.fromAssetId(1), // Cesium World Terrain
  {
    requestVertexNormals: true,
    requestWaterMask: true
  }
);
console.log('✓ World terrain loaded');
```

#### 2. Click-to-Fly

**Location:** `main.ts` - new method or modify `setupGlobeClickHandler()`

```typescript
private setupClickToFly() {
  const handler = new Cesium.ScreenSpaceEventHandler(this.viewer.scene.canvas);

  handler.setInputAction((click: any) => {
    const cartesian = this.viewer.camera.pickEllipsoid(
      click.position,
      this.viewer.scene.globe.ellipsoid
    );

    if (cartesian) {
      const cartographic = Cesium.Cartographic.fromCartesian(cartesian);

      // Fly to 5km above clicked point
      this.viewer.camera.flyTo({
        destination: Cesium.Cartesian3.fromRadians(
          cartographic.longitude,
          cartographic.latitude,
          5000 // 5km altitude
        ),
        orientation: {
          heading: this.viewer.camera.heading,
          pitch: Cesium.Math.toRadians(-45), // 45° downward pitch
          roll: 0
        },
        duration: 1.8,
        easingFunction: Cesium.EasingFunction.QUADRATIC_IN_OUT
      });
    }
  }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
}
```

#### 3. Altitude Display

**Location:** `main.ts` - new method

```typescript
private setupAltitudeDisplay() {
  // Create HUD element
  const altitudeDiv = document.createElement('div');
  altitudeDiv.style.cssText = `
    position: absolute;
    bottom: 16px;
    left: 16px;
    background: rgba(0, 0, 0, 0.65);
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font: 14px monospace;
    pointer-events: none;
    z-index: 1000;
  `;
  altitudeDiv.textContent = 'Altitude: --';
  document.body.appendChild(altitudeDiv);

  // Update on mouse move
  const handler = new Cesium.ScreenSpaceEventHandler(this.viewer.scene.canvas);

  handler.setInputAction((movement: any) => {
    const ray = this.viewer.camera.getPickRay(movement.endPosition);
    if (!ray) return;

    const position = this.viewer.scene.globe.pick(ray, this.viewer.scene);
    if (position) {
      const cartographic = Cesium.Cartographic.fromCartesian(position);
      const height = this.viewer.scene.globe.getHeight(cartographic) || 0;
      const cameraHeight = this.viewer.camera.positionCartographic.height;

      altitudeDiv.textContent = `Camera: ${(cameraHeight / 1000).toFixed(2)} km | Terrain: ${height.toFixed(0)} m`;
    }
  }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);
}
```

## Expected Performance Improvements

| Metric | ORACLE-004 (deck.gl) | ORACLE-005 (Cesium) | Improvement |
|--------|---------------------|---------------------|-------------|
| **FPS** | 0.4 FPS (unstable) | 60 FPS (stable) | **150x** |
| **Vertex Buffer Errors** | Frequent | None | **100%** |
| **Flickering** | Severe at zoom | None | **100%** |
| **Memory Usage** | ~120 MB | ~60 MB | **50%** |
| **Polar Region Rendering** | Broken | Perfect | **100%** |

## Migration Strategy

### Phase 1: Deprecation (Current)
1. Keep deck.gl code commented in render-worker.ts
2. Add deprecation warnings
3. Document switch reasoning

### Phase 2: Cesium Implementation (This PR)
1. Implement Cesium primitives in main.ts
2. Add UX enhancements (click-to-fly, altitude, terrain)
3. Test with small grid (128×128)

### Phase 3: Validation
1. Visual correctness: Verify CliMA RdBu-11 colors
2. Performance: Measure FPS with 100×100 grid
3. Stability: 24-hour stress test

### Phase 4: Cleanup (Future)
1. Remove deck.gl dependencies from package.json
2. Delete render-worker.ts or repurpose for other tasks
3. Update all documentation

## File Changes Summary

### Modified Files
1. **web/src/main.ts**
   - Add difference map primitive logic
   - Add click-to-fly handler
   - Add altitude display
   - Add CesiumWorldTerrain
   - Add SAB reading methods

2. **web/src/workers/render-worker.ts**
   - Add deprecation comments
   - Keep SAB pipeline for reference
   - Mark deck.gl code as legacy

3. **docs/v2.1_Upgrade.md**
   - Add note about ORACLE-005 pivot

### New Files
1. **docs/v2.2_ImpactMap_CesiumPivot.md** (this file)

## Testing Checklist

- [ ] Cesium primitives render at correct locations
- [ ] CliMA RdBu-11 colors match specification
- [ ] Baseline capture works correctly
- [ ] Delta normalization produces expected colors
- [ ] Click-to-fly navigates smoothly
- [ ] Altitude display shows correct values
- [ ] CesiumWorldTerrain loads successfully
- [ ] FPS remains at 60 with difference map enabled
- [ ] No console errors or warnings
- [ ] Memory usage is stable over time

## Future Enhancements (v2.3+)

### GPU-Based Subtraction
- Store baseline as WebGL texture
- Perform subtraction in fragment shader
- Expected: Additional 20% performance gain

### Multiple Baselines
- Support saving/loading multiple snapshots
- Enable A/B/C comparisons
- Timeline slider for temporal analysis

### Advanced Geometries
- Torsion tensor → instanced arrows
- Cloud particles → PointPrimitiveCollection
- Vegetation cover → 3D tree instances

## References

- [Cesium Primitive API](https://cesium.com/docs/cesiumjs-ref-doc/Primitive.html)
- [GeometryInstance](https://cesium.com/docs/cesiumjs-ref-doc/GeometryInstance.html)
- [PerInstanceColorAppearance](https://cesium.com/docs/cesiumjs-ref-doc/PerInstanceColorAppearance.html)
- [CesiumTerrainProvider](https://cesium.com/docs/cesiumjs-ref-doc/CesiumTerrainProvider.html)
- [CliMA Color Palettes](https://clima.github.io/ClimaAnalysis.jl/dev/colormaps/)

---

**Conclusion:** ORACLE-005 represents a strategic pivot from experimental deck.gl integration to production-stable Cesium primitives. This decision prioritizes stability, performance, and maintainability over architectural complexity.

**Next Steps:** Implement Cesium primitives in main.ts and verify 60 FPS performance.
